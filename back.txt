cmake_minimum_required(VERSION 3.10)
project(VirtualTouchCpp)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# --- 패키지 찾기 ---
find_package(OpenCV REQUIRED)
find_package(PkgConfig REQUIRED)
pkg_search_module(FFMPEG REQUIRED libavformat libavcodec libavutil libswscale libavdevice)
find_package(glog REQUIRED)
find_package(Threads REQUIRED)
find_package(Protobuf REQUIRED) # Protobuf 자체는 find_package로 찾습니다.

# --- X11 관련 라이브러리 찾기 ---
find_package(X11 REQUIRED)
find_library(XTEST_LIBRARY NAMES Xtst)
if(NOT XTEST_LIBRARY)
    message(FATAL_ERROR "libXtst를 찾을 수 없습니다. 'sudo apt-get install libxtst-dev'를 실행해보세요.")
endif()

# --- MediaPipe 경로 설정 ---
set(MEDIAPIPE_ROOT "/home/seo/virtual_touch/mediapipe")
set(MEDIAPIPE_BIN  "${MEDIAPIPE_ROOT}/bazel-bin")

# --- ✅ [수정 1] 필요한 모든 MediaPipe 및 의존성 라이브러리 탐색 ---
# file(GLOB ...)를 다시 사용하지만, 이번엔 모든 의존성을 포함시킵니다.
file(GLOB MEDIAPIPE_ALL_LIBS
    "${MEDIAPIPE_BIN}/mediapipe/**/*.so"
    "${MEDIAPIPE_BIN}/external/com_google_absl/**/*.so"
    "${MEDIAPIPE_BIN}/external/com_google_protobuf/**/*.so"
)

# --- 실행 파일 ---
add_executable(virtual_touch_app main.cpp)

target_include_directories(virtual_touch_app
    PRIVATE
    ${MEDIAPIPE_ROOT}
    "${MEDIAPIPE_ROOT}/bazel-mediapipe/external/com_google_absl"
    "${MEDIAPIPE_ROOT}/bazel-mediapipe/external/com_google_protobuf/src"
    "${MEDIAPIPE_BIN}"
    ${OpenCV_INCLUDE_DIRS}
    ${FFMPEG_INCLUDE_DIRS}
    ${X11_INCLUDE_DIR}
)

# --- ✅ [수정 2] 링커 그룹을 사용하여 모든 라이브러리를 연결 ---
target_link_libraries(virtual_touch_app
    PRIVATE
    # 링커 그룹 시작
    -Wl,--start-group
    ${MEDIAPIPE_ALL_LIBS}
    # 링커 그룹 끝
    -Wl,--end-group

    # 나머지 시스템 라이브러리들
    ${Protobuf_LIBRARIES}
    ${OpenCV_LIBS}
    glog::glog
    
    # ✅ [수정] FFmpeg 라이브러리를 직접 나열합니다.
    avformat
    avcodec
    swscale
    avutil
    avdevice

    Threads::Threads
    EGL GLESv2 GL
    
    ${X11_LIBRARIES}
    ${XTEST_LIBRARY}

    stdc++
)
